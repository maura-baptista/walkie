<%= render 'shared/carousel' %>
<div class="buttons">



  <%= link_to like_walk_path(@walk), remote: true do %>
    <% if Like.where(user: current_user, walk: @walk).empty?%>
    <span class="normal-button btn btn-default btn-circle far fa-heart go-rounded-white text-center" id="loveButton"></span>
      <% else %>
      <span class="normal-button btn btn-default btn-circle fas fa-heart go-rounded-white text-center" style="color: red;">
    <% end %>
  <% end %>
  <span class="normal-button btn btn-default btn-circle material-icons go-rounded-white text-center" style="padding:4px 8px 4px 5px;" onclick="">share</span>
  <span class="go-button btn btn-default btn-circle go-rounded-white text-center" style="margin-left: 30vw ;" data-target="#myModal" data-toggle="modal">GO</span>


<!-- Map Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style='width: 100%; height: 95vh;'>
        <div id='map' style=' height: 95vh;'></div>
        <div id='instructions'></div>
    </div>
  </div>
</div>

</div>

<%= render "points/form_modal"  %>

<div class="container">

  <div class="row">
    <div class="col-xs-12">
      <br>

      <br>
      <div class="d-inline categories">
        <h6><%= @walk.category.name%></h6>
        <h4 style="color: #161616 !important;"><strong> <%=@walk.name %></strong></h4>
        <br>
        <p class="tagline">&nbsp;<%= @walk.duration %>&nbsp;&nbsp;&nbsp;<i class="far fa-clock icon"></i>&nbsp;&nbsp;&nbsp;<%= @walk.location%>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<%= @walk.likes.length %>&nbsp;Likes</p>
        <hr>
        <br>
        <p><%= @walk.description %></p>

        <% if @walk.user == current_user %>
        <button class="btn btn-oblong btn-primary text-center" data-target="#modal-window" data-toggle="modal"> + points of interest</button>
        <% end %>

        <br>
<br>
      </div>
    </div>
  </div>



<% unless @walk.points.empty?%>
<div class="timeline">
  <div class="timeline__container container">
    <div class="timeline__start-line"></div>
    <div class="timeline__start">
      <h4>Points of interest</h4>
    </div>
    <% @walk.points.each do |point| %>
    <div class="timeline__item">
      <div class="timeline-item__line">
        <div class="timeline-item__line--circle"></div>
      </div>
      <div class="timeline-item__details">
        <div class="timeline-item__image" style="background-image: url('<%= image_path point.photo %>')">
        </div>
        <div class="timeline-item__legend">
          <p><%= point.order %>.<%=point.name %></p>
          <div><%= point.description %>.</div>
        </div>
      </div>
    </div>
    <% end %>
    <div class="timeline__end-line"></div>
    <div class="timeline__end">
      <h4>End</h4>
    </div>
  </div>
</div>

<% end %>

<br>
<br>


 <div>
  <h4>Reviews</h4>
  <% @reviews.each  do |review| %>
  <div class="message">
    <%= image_tag review.user.photo, class: "avatar-large" %>
  <div class="message-name">
    <h3><%=  review.user.first_name %></h3>
        <h3><%=  review.user.last_name %></h3>

  </div>
    <div class="message-body">
      "<%= review.content %>"
    </div>
  </div>
  <% end %>
</div>




  <script>
    var points = <%= raw @walk.points.to_json %>;
    var coordinates_url = '';
    mapboxgl.accessToken = 'pk.eyJ1IjoiZnJhbmNpc2NvYmFycmV0byIsImEiOiJjamVoMWRjMjMwbWh6MnFuczF6dGd6bmFoIn0.S5h45dvXuYQ3xoN-d504KA'; // replace this with your access token
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v9', // replace this with your style
      center: [points[0].longitude, points[0].latitude],
      zoom: 13,
      pitch: 45,
      bearing: -17.6,
      hash: true,
    });


    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    var coordinates = [];
    var features = [];
    points.forEach((point, index) => {
      coordinates.push([point.longitude, point.latitude]);

      var feature = {
                      "type": "Feature",
                      "properties": {
                          "description": point.description,
                          "icon": "bicycle"
                      },
                      "geometry": {
                          "type": "Point",
                          "coordinates": [point.longitude, point.latitude]
                      }
                  }

      features.push(feature);

      coordinates_url = coordinates_url + point.longitude + ',' + point.latitude;
      if(index + 1 < points.length) {
        coordinates_url = coordinates_url + ';';
      }
    });


  function getRoute() {

    var start = [points[0].longitude, points[0].latitude];
    var end = [points[6].longitude, points[6].latitude];

     var directionsRequest1 =
     'https://api.mapbox.com/directions/v5/mapbox/walking/'
     + coordinates_url + '?geometries=geojson&steps=true&access_token=' + mapboxgl.accessToken;


    var directionsRequest = 'https://api.mapbox.com/directions/v5/mapbox/cycling/' + start[0] + ',' + start[1] + ';' + end[0] + ',' + end[1] + '?geometries=geojson&access_token=' + mapboxgl.accessToken;

    $.ajax({
      method: 'GET',
      url: directionsRequest1,
    }).done(function(data) {
      var route = data.routes[0].geometry;
      var instructions = document.getElementById('instructions');
      console.log(data);
      var legs = data.routes[0].legs;
      legs.forEach(function(leg) {
        var steps = leg.steps;

        steps.forEach(function(step) {
          instructions.insertAdjacentHTML('beforeend', '<p>' + step.maneuver.instruction + '</p>');
        });
      });


      map.addLayer({
        id: 'route',
        type: 'line',
        source: {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: route
          }
        },
        paint: {
          'line-width': 3,
          'line-color': "#D17BC9"
        }
      });
      // this is where the code from the next step will go
      map.addLayer({
      id: 'start',
      type: 'circle',
      source: {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: start
          }
        }
      }
    });
    map.addLayer({
      id: 'end',
      type: 'circle',
      source: {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: end
          }
        }
      }
    });
    });


  }

//   map.on('load', function() {
//   getRoute();
// });

map.on('load', function () {

    var mapCanvas = document.getElementsByClassName('mapboxgl-canvas')[0];

    mapCanvas.style.height = '100%';
    mapCanvas.style.width = '100%';

    map.resize();


      getRoute();


      var layers = map.getStyle().layers;

      var labelLayerId;
      for (var i = 0; i < layers.length; i++) {
          if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
              labelLayerId = layers[i].id;
              break;
          }
      }

         map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 15,
        'paint': {
            'fill-extrusion-color': '#aaa',

            // use an 'interpolate' expression to add a smooth transition effect to the
            // buildings as the user zooms in
            'fill-extrusion-height': [
                "interpolate", ["linear"], ["zoom"],
                15, 0,
                15.05, ["get", "height"]
            ],
            'fill-extrusion-base': [
                "interpolate", ["linear"], ["zoom"],
                15, 0,
                15.05, ["get", "min_height"]
            ],
            'fill-extrusion-opacity': .6
        }
    }, labelLayerId);




        // map.addLayer({
        //     "id": "route",
        //     "type": "line",
        //     "source": {
        //         "type": "geojson",
        //         "data": {
        //             "type": "Feature",
        //             "properties": {},
        //             "geometry": {
        //                 "type": "LineString",
        //                 "coordinates": coordinates
        //             }
        //         }
        //     },
        //     "layout": {
        //         "line-join": "round",
        //         "line-cap": "round"
        //     },
        //     "paint": {
        //         "line-color": "#D17BC9",
        //         "line-width": 5
        //     }
        // });




        map.addLayer({
          "id": "places",
          "type": "symbol",
          "source": {
              "type": "geojson",
              "data": {
                  "type": "FeatureCollection",
                  "features": features


              }
          },
                "layout": {
                  "icon-image": "{icon}-15",
                  "icon-allow-overlap": true
                }
      });


          });


    map.on('click', 'places', function (e) {
        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = e.features[0].properties.description;


        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
    });

     // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', 'places', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'places', function () {
        map.getCanvas().style.cursor = '';
    });

    map.addControl(new mapboxgl.FullscreenControl());

    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: {
          enableHighAccuracy: true
      },
      trackUserLocation: true
    }));

    map.addControl(new MapboxGeocoder({
      accessToken: mapboxgl.accessToken
    }));



  </script>
  </div>



<script>
  document.getElementById("loveButton").addEventListener("mouseover" (event) => {
    event.currentTarget.classList.toggle("color-red");
   });

</script>
